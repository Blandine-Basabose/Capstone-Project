<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css?family=Andika" rel="stylesheet" />
    <link rel="stylesheet" href="/CSS/style.css" />
    <script src="https://www.gstatic.com/firebasejs/7.17.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.17.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.17.1/firebase-auth.js"></script>
    <title>Admin dashboard</title>
  </head>

  <body>
    <div class="dashboard">
      <div class="top">
        <img src="/Images/Blandine Basabose Usanase_Photo.JPG" alt="my profile" />
        <h2 class="navh2">Blondie's Dashboard</h2>
        <button id="logout">Logout</button>
      </div>
      <!-- <div class="bottom">
        <div class="left">
          
          <h3>Welcome Blandine</h3>

          
        </div> -->
        <div class="right">

          <div class="add-blog">
            <button class="btn" id="add-btn">Add Article</button>
          </div>
          <div class="loading"></div>
          <div class="blog-lists">
            
            <!-- <div class="blog">
              <a class="article" href="#" id="2">

        <div  class="article-img"><img src="../Images/Rectangle 20.png" alt="">
        </div>
        <h2>Title</h2>
        <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Dolorum error, doloribus nisi cupiditate cum
          repellendus ad maxime sit dolore voluptatum?</p>
    
    
          <button class="update"><i class="far fa-edit"></i></button>
          <button class="delete"><i class="far fa-trash-alt"></i></button>
              </a>
            </div>
            <div class="blog">
            
                    <a class="article" href="#" id="2">

        <div  class="article-img"><img src="../Images/Rectangle 20.png" alt="">
        </div>
        <h2>Title</h2>
        <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Dolorum error, doloribus nisi cupiditate cum
          repellendus ad maxime sit dolore voluptatum?</p>
    
    
        
              <button class="update"><i class="far fa-edit"></i></button>
          <button class="delete"><i class="far fa-trash-alt"></i></button>
              </a>
            </div>
            <div class="blog">
            
                    <a class="article" href="#" id="2">

        <div  class="article-img"><img src="../Images/Rectangle 20.png" alt="">
        </div>
        <h2>Title</h2>
        <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Dolorum error, doloribus nisi cupiditate cum
          repellendus ad maxime sit dolore voluptatum?</p>
    
    
        
              <button class="update"><i class="far fa-edit"></i></button>
          <button class="delete"><i class="far fa-trash-alt"></i></button>
              </a>
            </div>
          </div> -->
            <!-- <div class="form">
          </div> -->
          </div>
        </div>
      </div>

      <div class="form" >
        
        <form id="add-form">
          <div class="alert"></div>
          <input type="text" name="image" id="article-image" placeholder="Insert an image address">
          <input type="text" name="title" id="article-title" placeholder="Title" width="5px" , height="5px">
          <textarea name="content" id="description" placeholder="Content" cols="30" rows="10"></textarea>
          <button class="add-artcle-button">Add</button>
          <button class="update-article-btn">Update Article</button>

        </form>
      </div>


      <script>
        const firebaseConfig = {
          apiKey: "AIzaSyAmjSaPEpa8QqgNAtvam3mH56k8l9Loe6M",
          authDomain: "my-brand-832ab.firebaseapp.com",
          projectId: "my-brand-832ab",
          storageBucket: "my-brand-832ab.appspot.com",
          messagingSenderId: "779202197671",
          appId: "1:779202197671:web:0e6c4d03a059fcc2c18382",
          measurementId: "G-3SMX0EBXCN"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore()
        const auth = firebase.auth()

        const loading = document.querySelector('.loading');
        const alert = document.querySelector('.alert');
        const blogList = document.querySelector('.blog-lists');
        const image = document.querySelector('#article-image');
        const title = document.querySelector('#article-title');
        const content = document.querySelector('#description');
        const addBtns = document.querySelector('#add-btn');
        const blogForm = document.querySelector('#add-form');
        const addArticleForm = document.querySelector(".form");
        const addArticleBtn = document.querySelector(".add-artcle-button");
        const addBtn = document.querySelector("#add-btn");
        const logout = document.querySelector('#logout'); 
        const updateArticleBtns = document.querySelector('.update-article-btn');

        function displayArticles(articles){
          let blog = '';
          for(let i=0; i<articles.length; i++){
            let card =`
            <a class="article" href="" data-id=${articles[i].id
            }>
              <div  class="article-img">
                <img src='${articles[i].image}'> 
              </div>
                <h3>${articles[i].title}</h3>
                <p>
                  ${articles[i].content.substring(0, 120)}...</p>
                <div class = "action-btn">
                <button class="update"><i class="far fa-edit"></i></button>
                <button class="delete"><i class="far fa-trash-alt"></i></button>
                </div>
            </a>
            `;
            blog += card;
        
          }
          return blog;
        }

        //Adding article from display
        addBtn.addEventListener("click", () => {
          updateArticleBtns.style.display = 'none';
          addArticleForm.classList.toggle("form-display");
        });
        
        //Creating articles
        blogForm.addEventListener('submit', (e) => {
        
          e.preventDefault();
          if(!image.value || !title.value || !content.value){
            alert.style.display = 'block';
            alert.style.background ='red';
            alert.style.color = '#eeeeee';
            alert.innerHTML = 'Please fill in all the fields'; 
          }
          else{
            console.log(article);

          addArticleBtn.innerHTML += '<i class="fas fa-spinner fa-spin"></i>';
          addArticleBtn.setAttribute('disabled', 'disabled');

          db.collection('Blogs')
          .add(article)
          .then(() => {
          //   image: blogForm['article-image'].value,
          //   title: blogForm['article-title'].value,
          //   content: blogForm['description'].value
          // }).then(result => console.log('success')).catch(err => { console.log(err) })
          // document.querySelector('#article-image').value = '';
          // document.querySelector('#article-title').value = '';
          // document.querySelector('#description').value = '';
      
         
          alert.style.display = 'block';
          alert.innerHTML = `Article added successfully`;
          addArticleBtn.innerHTML = 'Add article';
          addArticleBtn.removeAttribute('disabled');
          setTimeout(()=>{
            addArticleForm.classList.toggle('form-display');
            window.location.reload();
          });
        });
      };
    });
        //Getting article data from firebase
        db.collection('Blogs').get().then(snapshot => {
          let articles =[];
         snapshot.docs.forEach((doc) => {
            articles.push({
              id:doc.id,
              title:doc.data().title,
              content:doc.data().content,
              image:doc.data().image

            });
           
          });

          let articlesContainer = document.querySelector('.blog-lists');
          console.log('ART::', articles);
          loading.style.display = 'none';
          articlesContainer.innerHTML= displayArticles(articles);

          const updateBtns = document.querySelectorAll('.update');
          const deleteBtns = document.querySelectorAll('.delete');
          
          updateBtns.forEach((button)=>{
            button.addEventListener('click', (e)=>{
              
              addArticleBtn.style.display = 'none';
              updateArticleBtns.style.display = 'block';
              button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
              e.preventDefault();
              const id=
              button.parentElement.parentElement.getAttribute('data-id');
            
            db.collection('Blogs')
              .doc(id)
              .get()
              .then((doc) => {
                image.value = doc.data().image;
                title.value = doc.data().title;
                content.value = doc.data().content;
                addArticleForm.classList.toggle("form-display");
                button.innerHTML = '<i class="far fa-edit"></i>';
                console.log(doc.data());

              updateArticleBtns.addEventListener('click',(e)=>{
              e.preventDefault();
              updateArticleBtns.innerHTML +=
                '<i class="fas fa-spinner fa-spin"></i>';
              const article = {
                image: image.value,
                title: title.value,
                content: content.value
              };
              console.log(article);
              db.collection('Blogs')
              .doc(id)
              .update(article)
              .then(()=>{
                alert.style.display = 'block';
                alert.innerHTML = `Article updated successfully`;
                updateArticleBtns.innerHTML = 'Updated';
                addArticleForm.classList.remove('form-display');

              });
              });
            });
            });
          });
          deleteBtns.forEach((btn) => {
          btn.addEventListener('click', (e) =>{
            e.preventDefault();
            const id= 
            btn.parentElement.parentElement.getAttribute('data-id');
          //delete article
          db.collection('Blogs')
            .doc(id)
            .delete()
            .then(() => {
              btn.innerHTML = '<i class="far fa-trash-alt"></i>';
              window.location.reload();
            
          });
        });
      });
      });

        // //Logging out
            
        logout.addEventListener('click', (e) => {
          e.preventDefault();
          auth.signOut().then(() => {
            console.log('user signed out');
          })
          //After successful logout, Admin will be redirected to blog.html
          firebase.auth().signOut();
          window.location = 'blog.html';
        });
      </script>
      <script src="../scripts/capstone.js"></script>
      <script src="https://kit.fontawesome.com/0bc2a4a873.js" crossorigin="anonymous"></script>
  </body>

</html>